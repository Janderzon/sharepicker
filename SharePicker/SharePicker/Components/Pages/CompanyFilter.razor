@page "/CompanyFilter"

@using Microsoft.AspNetCore.Authorization
@using SharePicker.Models
@using SharePicker.Services

@* @attribute [Authorize] *@
@inject FinancialStatementRepository FinancialStatementRepository

<MudStack>
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h2">Filter Builder</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudSelect T="Exchange"
                       Label="Exchanges"
                       MultiSelection="true"
                       SelectAll="true"
                       MultiSelectionTextFunc="GetExchangeSelectionText"
                       @bind-SelectedValues=_selectedExchanges>
                @foreach (var exchange in _exchanges)
                {
                    <MudSelectItem Value="@exchange">@exchange.ShortName</MudSelectItem>
                }
            </MudSelect>
        </MudCardContent>
        <MudCardActions>
            <MudButton Disabled="_processing" Variant="Variant.Filled" Color="Color.Primary" OnClick="GetResults">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Filter</MudText>
                }
            </MudButton>
        </MudCardActions>
    </MudCard>
    @if (_results != null)
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h2">Results</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudDataGrid Items="_results" Virtualize="true" FixedHeader="true" Height="350px">
                    <Columns>
                        <PropertyColumn Property="company => company.Symbol" Title="Symbol" />
                        <PropertyColumn Property="company => company.Name" Title="Name"/>
                        <PropertyColumn Property="company => company.Exchange.ShortName" Title="Exchange" />
                    </Columns>
                </MudDataGrid>
            </MudCardContent>
        </MudCard>
    }
</MudStack>

@code {
    private IEnumerable<Exchange> _exchanges = new List<Exchange>();
    private IEnumerable<Exchange> _selectedExchanges = new List<Exchange>();
    private IEnumerable<Company>? _results;
    private bool _processing;

    protected override async Task OnInitializedAsync()
    {
        var exchanges = await FinancialStatementRepository.GetExchanges(CancellationToken.None);

        _exchanges = exchanges.OrderBy(exchange => exchange.ShortName);
    }

    private string GetExchangeSelectionText(List<string> selectedValues) => selectedValues.Count == 0 
        ? "No exchanges selected"
        : $"{selectedValues.Count} exchange{(selectedValues.Count > 1 ? "s" : "")} selected";

    private async Task GetResults()
    {
        _processing = true;
        var companies = await FinancialStatementRepository.GetCompaniesAsync(CancellationToken.None);
        var selectedExchanges = _selectedExchanges.ToHashSet();
        _results = companies.Where(company => selectedExchanges.Contains(company.Exchange));
        _processing = false;
    }
}
